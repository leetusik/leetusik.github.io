<!DOCTYPE html>
<html class="no-js" lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>coupang TV[2] - 백엔드 - 이투식</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="이투식" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/leetusik_black.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">이투식</div>
					<div class="logo__tagline">이런 투자 방식</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">ABOUT</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">coupang TV[2] - 백엔드</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 1 1 0 28 1 1 0 0 1 0-28m0 3a3 3 0 1 0 0 22 3 3 0 0 0 0-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class="meta__text" datetime="2024-08-07T06:51:55&#43;09:00">2024-08-07</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/services/" rel="category">Services</a>
	</span>
</div></div>
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#스크래핑">스크래핑</a>
      <ul>
        <li><a href="#1-쿠팡에서-tv-정보-수집">1. 쿠팡에서 TV 정보 수집</a></li>
        <li><a href="#2-수집-정보-바탕으로-다나와에서-스펙-수집">2. 수집 정보 바탕으로 다나와에서 스펙 수집</a></li>
        <li><a href="#3-쿠팡-url---쿠팡-파트너스-url-변환">3. 쿠팡 url -&gt; 쿠팡 파트너스 url 변환</a></li>
      </ul>
    </li>
    <li><a href="#데이터베이스-모델">데이터베이스 모델</a>
      <ul>
        <li><a href="#1-제품-테이블">1. 제품 테이블</a></li>
        <li><a href="#2-특성-테이블">2. 특성 테이블</a></li>
        <li><a href="#3-제품-과거-가격-테이블">3. 제품 과거 가격 테이블</a></li>
        <li><a href="#4-데이터-전처리-함수">4. 데이터 전처리 함수</a></li>
      </ul>
    </li>
    <li><a href="#수정-필요-사항">수정 필요 사항</a></li>
    <li><a href="#같은-주제-게시글-모음">같은 주제 게시글 모음</a></li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<p>이번 글에서는 프로젝트 백엔드 부분을 소개한다. 스크래핑 기능, 데이터베이스 모델을 중점적으로 다룬다.</p>
<h2 id="스크래핑">스크래핑</h2>
<ol>
<li>쿠팡에서 TV 정보 수집</li>
<li>수집 정보 바탕으로 다나와에서 스펙 수집</li>
<li>쿠팡 url -&gt; 쿠팡 파트너스 url 변환</li>
</ol>
<hr>
<h3 id="1-쿠팡에서-tv-정보-수집">1. 쿠팡에서 TV 정보 수집</h3>
<p>사용한 파이썬 라이브러리: <code>requests</code>, <code>bs4</code></p>
<p>쿠팡은 처음 <code>url</code>을 어떻게 설정하느냐에 따라 검색 결과가 많이 달라진다. 때문에 디테일하게 설정해야한다.</p>
<h4 id="11-기본-url">1.1 기본 URL</h4>
<pre tabindex="0"><code># 전체 url
https://www.coupang.com/np/search?rocketAll=true&amp;q=tv&amp;brand=6231%2C258%2C259%2C50444%2C3143%2C53215%2C49912%2C40385%2C46698%2C17260%2C75039%2C49609%2C72371%2C56188%2C19476%2C106528%2C3154%2C75097%2C17437%2C19237&amp;filterType=rocket%2Crocket_luxury%2Crocket_wow%2Ccoupang_global&amp;isPriceRange=true&amp;priceRange=100000&amp;minPrice=100000&amp;maxPrice=2147483647&amp;sorter=saleCountDesc&amp;listSize={listSize}&amp;page={page}
</code></pre><pre tabindex="0"><code>- https://www.coupang.com/np/
  - 쿠팡 기본 url

- search?rocketAll=true&amp;q=tv
  - 검색시작, 로켓배송 필터, tv 검색

- brand=6231%2C258%2C259%2C50444%2C3143%2C53215%2C49912%2C40385%2C46698%2C17260%2C75039%2C49609%2C72371%2C56188%2C19476%2C106528%2C3154%2C75097%2C17437%2C19237
  - 브랜드 설정, 모든 브랜드 선택

- filterType=rocket%2Crocket_luxury%2Crocket_wow%2Ccoupang_global&amp;isPriceRange=true&amp;priceRange=100000&amp;minPrice=100000&amp;maxPrice=2147483647
  - filterType은 자동 설정됨, 가격 10만원 이상 필터(10만원 이하로 내려가면 tv 부자재가 나옴)

- sorter=saleCountDesc&amp;listSize={listSize}&amp;page={page}
  - 판매량 내림차순 정렬, 리스트사이즈 설정, 페이지 설정
    - 리스트 사이즈는 100(max)로 설정해서 최소한의 트래픽 일으킴
    - 페이지는 1부터 일정 조건 도달할 때까지 루프
</code></pre><h4 id="12-header">1.2 Header</h4>
<p>User-Agent와 Accept-Language를 설정해줘야한다. 특히 Accept-Language를 설정하지 않으면 리퀘스트 응답이 안온다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;User-Agent&#34;</span>: <span style="color:#e6db74">&#34;your user agent&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Accept-Language&#34;</span>: <span style="color:#e6db74">&#34;en-US,en;q=0.9,ko-KR;q=0.8,ko;q=0.7&#34;</span>,
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h4 id="13-기본-url에서-수집하는-정보">1.3 기본 URL에서 수집하는 정보</h4>
<p>기본 URL에서는 다음의 항목을 수집한다.</p>
<ol>
<li>제품명</li>
<li>모델명</li>
<li>설치 방법(방문설치 or 자가설치)</li>
<li>tv 유형(벽걸이형 or 스탠드형)</li>
<li>제품 사진</li>
<li>리뷰 점수, 리뷰 수</li>
</ol>
<p>일반적인 경우 제품명에 모델명, 설치방법, tv 유형이 포함되어있다.</p>
<blockquote>
<p>샤오미 안드로이드11 4K UHD LED A Pro TV, 165cm(65인치), L65M8-A2KR, 스탠드형, 방문설치</p>
</blockquote>
<p>split function을 활용해서 각각의 정보를 찾는데, 해당 단어가 제품명에 포함되어있는지 확인하면 되는 설치 방법이나 tv 유형과 달리 <code>모델명</code>은 단순히 포함 유무를 가지고 판단할 수 없기 때문에 <code>정규표현식</code>을 활용하여 수집한다.</p>
<h5 id="활용된-정규표현식">활용된 정규표현식</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Define the pattern to match the model names</span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;^(?=.*[A-Z])(?=.*[0-9])[A-Z0-9]+(-[A-Z0-9]+)?(\(.*\))?$&#34;</span>)
</span></span><span style="display:flex;"><span>pattern2 <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;\b[A-Za-z]{1,2}\d{2,}([A-Za-z0-9]*[A-Za-z]{1,2}[A-Za-z0-9]*)?\b&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h5 id="정규표현식을-활용한-모델명-구하는-함수">정규표현식을 활용한 모델명 구하는 함수</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_model_name</span>(name):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    function name = get_model_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    params =
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        div tag
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    explain = This function get model name from product title.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex) PRISM 4K UHD TV, 139.7cm(55인치), PTC550UD, 스탠드형, 방문설치 -&gt; PTC550UD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name_split <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> name_split:
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">=</span> n<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pattern<span style="color:#f92672">.</span>search(n):
</span></span><span style="display:flex;"><span>            model_name <span style="color:#f92672">=</span> n
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no model name&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> model_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;no model name&#34;</span>:
</span></span><span style="display:flex;"><span>        name_split <span style="color:#f92672">=</span> name<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> name_split:
</span></span><span style="display:flex;"><span>            n <span style="color:#f92672">=</span> n<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> pattern<span style="color:#f92672">.</span>search(n):
</span></span><span style="display:flex;"><span>                model_name <span style="color:#f92672">=</span> n
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(model_name) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                model_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no model name&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check if model_name is &#34;no model name&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> model_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;no model name&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> <span style="color:#f92672">=</span> pattern2<span style="color:#f92672">.</span>search(name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">match</span>:
</span></span><span style="display:flex;"><span>            model_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span><span style="color:#f92672">.</span>group()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> name<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;TCL&#34;</span>) <span style="color:#f92672">and</span> len(model_name) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> <span style="color:#f92672">=</span> size_pattern<span style="color:#f92672">.</span>search(name)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">match</span>:
</span></span><span style="display:flex;"><span>                size <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span><span style="color:#f92672">.</span>group()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(size) <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>                    size <span style="color:#f92672">=</span> size[:<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    size <span style="color:#f92672">=</span> size[:<span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>                model_name <span style="color:#f92672">=</span> size <span style="color:#f92672">+</span> model_name
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> model_name
</span></span></code></pre></div><p>패턴 1을 통해 1차로 모델명을 구한 뒤, 모델명을 구하지 못한 상품들을 대상으로 패턴 2를 통해 2차로 모델명을 구한다.
TCL 브랜드 모델명의 경우 쿠팡 제품명 속 모델명이 3글자가 되지 않는 경우가 있었고 <code>ex) V6B</code> 정식 모델명은 사이즈 + 모델명이었기 때문에 <code>ex) 43V6B</code> 예외 처리하여 따로 구했다.</p>
<h4 id="14-제품-상세-url-에서-수집하는-정보">1.4 제품 상세 URL 에서 수집하는 정보</h4>
<ol>
<li>기본 가격</li>
<li>할인 가격</li>
<li>쿠폰 가격</li>
<li>브랜드명</li>
<li>짧은 제품명</li>
<li>제품 URL</li>
</ol>
<p>제품 상세 url은 기본 URL에서 수집한 상품 리스트에서 추출한다. 쿠팡 가격에는 크게 3가지 가격이 있는데, 위의 1, 2, 3번이 그것이다.</p>
<pre tabindex="0"><code># 기본적으로 다음과 같다.
기본 가격 &gt; 할인 가격 &gt; 쿠폰 가격
</code></pre><p>브랜드명은 제품명 제일 앞에 위치하지만, 쿠팡 상세 제품 페이지에는 브랜드명을 기입할 수 있는 별도의 공간이 있다. 그곳에 브랜드명이 기입되어있지 않다면 <code>중소기업</code>으로 분류했다.</p>
<hr>
<h4 id="15-기본-정보-데이터베이스-저장">1.5 기본 정보 데이터베이스 저장</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># scraper_basic.py 일부.</span>
</span></span><span style="display:flex;"><span>product_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: name,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;short_name&#34;</span>: short_name,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;model_name&#34;</span>: model_name,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;install_info&#34;</span>: install_info,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;tv_type&#34;</span>: tv_type,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;product_pic_s&#34;</span>: product_pic_s,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;rating&#34;</span>: rating,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;rating_count&#34;</span>: rating_count,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;original_price&#34;</span>: original_price,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sale_price&#34;</span>: sale_price,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;coupon_price&#34;</span>: coupon_price,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;highest_price&#34;</span>: highest_price,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;lowest_price&#34;</span>: lowest_price,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;discount_rate&#34;</span>: discount_rate,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;brand&#34;</span>: brand,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;product_url&#34;</span>: product_url,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update_or_create_product(product_data)
</span></span></code></pre></div><p>위의 과정을 통해 모은 데이터를 데이터베이스에 저장한다. 이미 데이터베이스에 해당 제품이 있을 경우에는 가격등 정보를 업데이트하고 제품이 없을 경우에는 새로운 instance를 추가한다.</p>
<hr>
<h3 id="2-수집-정보-바탕으로-다나와에서-스펙-수집">2. 수집 정보 바탕으로 다나와에서 스펙 수집</h3>
<p>쿠팡에도 tv 제품에 대한 스펙 사항이 표로 정리되어 있기는 하지만 제품마다 다루는 종목이 상이하다. 쿠팡 상품 상세 설명에 있는 이미지를 LLM을 활용해 해석해서 특성을 추출할까했지만 일이 너무 복잡해져서 그 방법은 보류했다.</p>
<p>대신 <a href="https://search.danawa.com/dsearch.php">다나와</a>에서 모델명을 검색해서 제품 스펙 사항을 수집했다. 다나와도 마찬가지로 스펙 종목이 제품마다 상이했지만 그 수가 많고 반복적이었기 때문에 데이터베이스에 정리하기 용이했다.</p>
<p>사용한 파이썬 라이브러리: <code>requests</code>, <code>bs4</code></p>
<h4 id="21-제품-스펙-데이터-수집-및-전처리">2.1 제품 스펙 데이터 수집 및 전처리</h4>
<p>제품 스펙 데이터 자체는 얻는데 문제가 없었지만, 잘 정리되어있지 않았기 때문에 전처리하는 과정이 필요했다.</p>
<div style="text-align: center">
  <img src="spec_ex.png" alt="스펙 이미지 예시" style="max-width: 100%;
  height: auto;">
  <div style="font-size: 0.9em; color: gray">스펙 이미지 예시</div>
  <br />
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 제품 스펙 html 예시) 모델명 KQ65LSB01AFXKR의 경우--&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spec_list&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;view_dic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$.termDicViewLink(31510, &#39;view&#39;, this, 0, 149, 180); return false;&#34;</span>
</span></span><span style="display:flex;"><span>    &gt;&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cm_mark&#34;</span>&gt;QLED TV&lt;/<span style="color:#f92672">span</span>&gt;&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>&gt;&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cm_mark&#34;</span>&gt;65인치(163cm)&lt;/<span style="color:#f92672">span</span>&gt;&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;view_dic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$.termDicViewLink(228906, &#39;view&#39;, this, 0, 149, 180); return false;&#34;</span>
</span></span><span style="display:flex;"><span>    &gt;4K UHD&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;view_dic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$.termDicViewLink(382, &#39;view&#39;, this, 0, 149, 180); return false;&#34;</span>
</span></span><span style="display:flex;"><span>    &gt;&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cm_mark&#34;</span>&gt;60Hz&lt;/<span style="color:#f92672">span</span>&gt;&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>&gt;&lt;<span style="color:#f92672">br</span> /&gt;&lt;<span style="color:#f92672">span</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cm_mark&#34;</span>&gt;[화질]&lt;/<span style="color:#f92672">span</span>&gt; 퀀텀4K&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;view_dic&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$.termDicViewLink(219549, &#39;view&#39;, this, 0, 149, 180); return false;&#34;</span>
</span></span><span style="display:flex;"><span>    &gt;HDR10+&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>  &gt;&lt;<span style="color:#f92672">em</span>&gt;/&lt;/<span style="color:#f92672">em</span>&gt;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p>table로 정리되어있지않다. 그리고 html을 soup로 변환시켜서 해당 div의 text를 가져왔을 때 스펙 사항만 깔끔하게 가져오지는 못해서 전처리가 필요했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># scrape_feautre.py 일부</span>
</span></span><span style="display:flex;"><span>spec_list <span style="color:#f92672">=</span> spec_list<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>spec_list <span style="color:#f92672">=</span> spec_list<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>clean_spec_list <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    spec<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#66d9ef">for</span> spec <span style="color:#f92672">in</span> spec_list
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize the dictionary</span>
</span></span><span style="display:flex;"><span>dic <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;기본&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;screen_size&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;display_tech&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;resolution&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;refresh_rate&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;화질&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;사운드&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;스마트&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;부가&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;보증기간&#34;</span>: {},
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;게임&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Populate the dictionary</span>
</span></span><span style="display:flex;"><span>current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;기본&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> spec <span style="color:#f92672">in</span> clean_spec_list:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;[화질]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;화질&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;[게임]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;게임&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;[스마트]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;스마트&#34;</span>
</span></span><span style="display:flex;"><span>        dic[current_category][spec<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;[스마트] &#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;[사운드]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;사운드&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;[부가]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;부가&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;[보증기간]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>        current_category <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;보증기간&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> current_category <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;기본&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;인치&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>            dic[<span style="color:#e6db74">&#34;기본&#34;</span>][<span style="color:#e6db74">&#34;screen_size&#34;</span>] <span style="color:#f92672">=</span> extract_screen_size(spec)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> spec<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;ED&#34;</span>):
</span></span><span style="display:flex;"><span>            dic[<span style="color:#e6db74">&#34;기본&#34;</span>][<span style="color:#e6db74">&#34;display_tech&#34;</span>] <span style="color:#f92672">=</span> spec
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> spec<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;HD&#34;</span>):
</span></span><span style="display:flex;"><span>            dic[<span style="color:#e6db74">&#34;기본&#34;</span>][<span style="color:#e6db74">&#34;resolution&#34;</span>] <span style="color:#f92672">=</span> spec
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> <span style="color:#e6db74">&#34;주사율&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>            dic[<span style="color:#e6db74">&#34;기본&#34;</span>][<span style="color:#e6db74">&#34;refresh_rate&#34;</span>] <span style="color:#f92672">=</span> spec<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;: &#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;]&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>            spec <span style="color:#f92672">=</span> spec<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;]&#34;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">in</span> spec:
</span></span><span style="display:flex;"><span>            spec_split <span style="color:#f92672">=</span> spec<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>            k <span style="color:#f92672">=</span> spec_split[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            v <span style="color:#f92672">=</span> spec_split[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> v <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;X&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            dic[current_category][k] <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(spec) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">20</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        dic[current_category][spec] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;model name : </span><span style="color:#e6db74">{</span>model_name<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> spec list: </span><span style="color:#e6db74">{</span>clean_spec_list<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">del</span> dic[<span style="color:#e6db74">&#34;보증기간&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cat <span style="color:#f92672">in</span> dic:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> feature <span style="color:#f92672">in</span> dic[cat]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> feature <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;크기(가로x세로x깊이)&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        code <span style="color:#f92672">=</span> codes[cat]
</span></span><span style="display:flex;"><span>        check_and_add_feature_name(
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>feature,
</span></span><span style="display:flex;"><span>            value<span style="color:#f92672">=</span>dic[cat][feature],
</span></span><span style="display:flex;"><span>            feature_code<span style="color:#f92672">=</span>code,
</span></span><span style="display:flex;"><span>            prod<span style="color:#f92672">=</span>product,
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>우선 em tag의 &lsquo;'을 기준으로 스펙 사항을 분리한다. 그리고 불필요한 요소를 제거한 clean_spec_list를 만든다.
그리고 스펙리스트 하나하나의 사항을 for 문을 통해 어떤 구분에 대한 스펙인지 분류하고, 데이터베이스에 저장하기위한 전 작업을한다.</p>
<p>오직 다나와의 지저분한 정보를 수집하기위해 재활용 가능성이 낮은 코드를 작성했지만, 그래도 깨끗하지않은 정보를 나름대로 정리할 수 있었다.</p>
<hr>
<h3 id="3-쿠팡-url---쿠팡-파트너스-url-변환">3. 쿠팡 url -&gt; 쿠팡 파트너스 url 변환</h3>
<p>사용한 파이썬 라이브러리: <code>selenium</code>, <code>dotenv</code>, <code>undetected_chromedriver</code></p>
<p>제품 url을 그대로 가져와서 옮기기만 하면 쿠팡 파트너스로서 수익을 창출할 수 없다. 오직 쿠팡 파트너스 페이지를 통해 변환된 url을 통해 유입되어야 그 유입으로 인해 매출이 발생했을 때 수수료를 얻는다.</p>
<p>쿠팡 파트너스에서 파트너스 API를 통해 제품 url을 파트너스 url로 변환하는 서비스를 제공하긴 하지만 일정 수준 이상 수익이 발생한 파트너 중 쿠팡의 심사에 통과한 파트너에게만 제공한다.</p>
<div style="text-align: center">
  <img src="partners_api.png" alt="파트너스 api" style="max-width: 100%;
  height: auto;">
  <div style="font-size: 0.9em; color: gray">파트너스 api 활용 docs</div>
  <br />
</div>

<h4 id="31-심사에-통과하지-못한-자의-링크-생성">3.1 심사에 통과하지 못한 자의 링크 생성</h4>
<p>원래는 모델명을 검색해서 나오는 리스트 중 내 제품과 일치하는 제품을 찾아서 일일히 링크를 생성해야했다. 링크를 생성하는 과정에서 정확히 같은 제품이어야했기 때문에 제품 이미지 정보를 활용해서 같은 이미지 소스를 가지고 있는 제품을 선택하곤 했다. 하지만 같은 이미지를 여러 다른 모델에 활용하는 경우도 있는 등 애로사항이 발생하던 차에 간편 링크 만들기 기능이 추가되었다. 간편 링크 만들기 기능은 상품의 url을 입력하면 파트너스 url로 변환하여 제공한다.
<div style="text-align: center">
  <img src="link_ex.png" alt="간편 링크 생성 예시" style="max-width: 100%;
  height: auto;">
  <div style="font-size: 0.9em; color: gray">간편 링크 생성 예시</div>
  <br />
</div>
</p>
<p>이 기능을 selenium을 통해 자동화하여 약 500개의 파트너스 api를 얻어보고자 한다.</p>
<h4 id="32-링크-생성-자동화---로그인">3.2 링크 생성 자동화 - 로그인</h4>
<p>쿠팡 파트너스 로그인을 위해 프로젝트 root 디렉토리에 .env file을 만들어 로그인 정보를 저장한다. 저장된 .env 파일이 깃헙에 업로드되면 안되기 때문에 .gitignore 파일에 .env를 추가한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.env" data-lang=".env"><span style="display:flex;"><span>ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your coupang email&#34;</span>
</span></span><span style="display:flex;"><span>PW<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your coupang password&#34;</span>
</span></span></code></pre></div><p>그리고 .env 정보를 활용하여 쿠팡에 로그인한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># scraper_url2.py의 일부</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load environment variables from .env file</span>
</span></span><span style="display:flex;"><span>load_dotenv()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get ID and password from environment variables</span>
</span></span><span style="display:flex;"><span>user_id <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;ID&#34;</span>)
</span></span><span style="display:flex;"><span>user_password <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;PW&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login_coupang</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Login to Coupang partners</span>
</span></span><span style="display:flex;"><span>    login_input <span style="color:#f92672">=</span> wait<span style="color:#f92672">.</span>until(
</span></span><span style="display:flex;"><span>        EC<span style="color:#f92672">.</span>presence_of_element_located((By<span style="color:#f92672">.</span>ID, <span style="color:#e6db74">&#34;login-email-input&#34;</span>))
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    password_input <span style="color:#f92672">=</span> wait<span style="color:#f92672">.</span>until(
</span></span><span style="display:flex;"><span>        EC<span style="color:#f92672">.</span>presence_of_element_located((By<span style="color:#f92672">.</span>ID, <span style="color:#e6db74">&#34;login-password-input&#34;</span>))
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    submit_button <span style="color:#f92672">=</span> wait<span style="color:#f92672">.</span>until(
</span></span><span style="display:flex;"><span>        EC<span style="color:#f92672">.</span>element_to_be_clickable(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                By<span style="color:#f92672">.</span>CSS_SELECTOR,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;.login__button.login__button--submit._loginSubmitButton.login__button--submit-rds&#34;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    login_input<span style="color:#f92672">.</span>send_keys(user_id)
</span></span><span style="display:flex;"><span>    password_input<span style="color:#f92672">.</span>send_keys(user_password)
</span></span><span style="display:flex;"><span>    submit_button<span style="color:#f92672">.</span>click()
</span></span></code></pre></div><h4 id="33-링크-생성-자동화---모달-대응">3.3 링크 생성 자동화 - 모달 대응</h4>
<p>로그인 후 링크를 수집하다보면 200~300개를 수집했을 때 쯤 비밀번호를 다시 입력하라는 모달이 나오면서 스크래핑을 방해한다. 이에 대응하기 위해 아래와 같은 함수를 만들어서 스크래핑 과정 중간중간에 함수를 호출했다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># scraper_url2.py 중 일부</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to handle the modal</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_modal</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        modal_present <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element(By<span style="color:#f92672">.</span>CLASS_NAME, <span style="color:#e6db74">&#34;ant-modal-content&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> modal_present:
</span></span><span style="display:flex;"><span>            password_input <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element(By<span style="color:#f92672">.</span>ID, <span style="color:#e6db74">&#34;password&#34;</span>)
</span></span><span style="display:flex;"><span>            password_input<span style="color:#f92672">.</span>send_keys(user_password)
</span></span><span style="display:flex;"><span>            confirm_button <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element(
</span></span><span style="display:flex;"><span>                By<span style="color:#f92672">.</span>XPATH, <span style="color:#e6db74">&#34;//button[@type=&#39;submit&#39;]&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            confirm_button<span style="color:#f92672">.</span>click()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Wait until modal disappears</span>
</span></span><span style="display:flex;"><span>            WebDriverWait(driver, <span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>until(
</span></span><span style="display:flex;"><span>                EC<span style="color:#f92672">.</span>invisibility_of_element_located(
</span></span><span style="display:flex;"><span>                    (By<span style="color:#f92672">.</span>CLASS_NAME, <span style="color:#e6db74">&#34;ant-modal-content&#34;</span>)
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;modal handled@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(&#34;No modal present or error handling modal&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>모달이 없을 때에는 try except 문에서 except가 발동되면서 아무일도 일어나지 않고, 모달이 있을 때에는 try가 완료되면서 모달에 비밀번호를 입력한다.</p>
<h4 id="34-링크-생성-자동화---늦은-url--반복-url-대응">3.4 링크 생성 자동화 - 늦은 url / 반복 url 대응</h4>
<p>링크를 반복적으로 빠르게 생성하다보면 어떤 이유에서인지 url이 늦게 생성되거나 그 전의 제품과 같은 url로 미리 값이 입력되어있어 잘못된 정보를 수집하는 경우가 있었다. 이를 방지하기위해 그 전의 제품 파트너스 url과 지금 생성된 파트너스 url이 다른지 확인하는 함수를 만들었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># scraper_url2.py 중 일부</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define a custom wait condition</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">text_is_not_none</span>(driver):
</span></span><span style="display:flex;"><span>    shorten_url <span style="color:#f92672">=</span> wait<span style="color:#f92672">.</span>until(
</span></span><span style="display:flex;"><span>        EC<span style="color:#f92672">.</span>presence_of_element_located(
</span></span><span style="display:flex;"><span>            (
</span></span><span style="display:flex;"><span>                By<span style="color:#f92672">.</span>CSS_SELECTOR,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;.unselectable-input.tracking-url-input.large&#34;</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    condition <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> condition:
</span></span><span style="display:flex;"><span>        element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element(
</span></span><span style="display:flex;"><span>            By<span style="color:#f92672">.</span>CSS_SELECTOR, <span style="color:#e6db74">&#34;.unselectable-input.tracking-url-input.large&#34;</span>
</span></span><span style="display:flex;"><span>        )<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(f&#34;current url = {element}, previous url = {previous_url}&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> element <span style="color:#f92672">==</span> previous_url:
</span></span><span style="display:flex;"><span>            handle_modal()
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;repeat link error. try again...&#34;</span>)
</span></span><span style="display:flex;"><span>            time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            condition <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> element
</span></span></code></pre></div><h4 id="35-수집한-파트너스-url-데이터베이스-저장">3.5 수집한 파트너스 url 데이터베이스 저장</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, len(products) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        the_product <span style="color:#f92672">=</span> products[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># the_product.shorten_url = None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(the_product<span style="color:#f92672">.</span>id, the_product<span style="color:#f92672">.</span>model_name)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> the_product<span style="color:#f92672">.</span>shorten_url:
</span></span><span style="display:flex;"><span>            print(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>the_product<span style="color:#f92672">.</span>model_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> already got shorten_url: </span><span style="color:#e6db74">{</span>the_product<span style="color:#f92672">.</span>shorten_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            handle_modal()
</span></span><span style="display:flex;"><span>            shorten_url_text <span style="color:#f92672">=</span> get_shorten_url(the_product, driver)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Introduce a random delay between 1 and 3 seconds</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(random<span style="color:#f92672">.</span>uniform(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update the Product with the shorten_url</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> the_product:
</span></span><span style="display:flex;"><span>            the_product<span style="color:#f92672">.</span>shorten_url <span style="color:#f92672">=</span> shorten_url_text
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><p>만약 제품이 이미 파트너스 url(shorten_url)이 있다면 패스하고, 없다면 파트너스 url을 수집했다. 수집한 url은 위와 같이 데이터베이스에 저장한다.</p>
<hr>
<hr>
<h2 id="데이터베이스-모델">데이터베이스 모델</h2>
<ol>
<li>제품 테이블</li>
<li>제품 특성 테이블</li>
<li>제품 과거 가격 테이블</li>
<li>데이터 전처리 함수</li>
</ol>
<hr>
<h3 id="1-제품-테이블">1. 제품 테이블</h3>
<p>제품 테이블 필드 구성을 소개한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># models.py 일부</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Product</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    short_name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    model_name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    install_info <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    tv_type <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    product_pic_s <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    rating <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    rating_count <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    original_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    sale_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    coupon_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    highest_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    lowest_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    discount_rate <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    brand <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    product_url <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    shorten_url <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    last_checked <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Date, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, default<span style="color:#f92672">=</span>date<span style="color:#f92672">.</span>today)
</span></span><span style="display:flex;"><span>    features_scraped <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Boolean, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, default<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    best_offer <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Boolean, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, default<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Unique constraint</span>
</span></span><span style="display:flex;"><span>    __table_args__ <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>UniqueConstraint(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#e6db74">&#34;model_name&#34;</span>, <span style="color:#e6db74">&#34;tv_type&#34;</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_name_model_tvtype_uc&#34;</span>
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Relationship with Feature</span>
</span></span><span style="display:flex;"><span>    features <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Feature&#34;</span>,
</span></span><span style="display:flex;"><span>        secondary<span style="color:#f92672">=</span>product_features,
</span></span><span style="display:flex;"><span>        backref<span style="color:#f92672">=</span>db<span style="color:#f92672">.</span>backref(<span style="color:#e6db74">&#34;products&#34;</span>, lazy<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Relationship with ProductLowestPriceHistory</span>
</span></span><span style="display:flex;"><span>    lowest_price_history <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>relationship(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ProductLowestPriceHistory&#34;</span>, backref<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;product&#34;</span>, lazy<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>솔직히 크게 자신은 없다. 특히 필드 속성을 best로 설정했는지는 모르겠고, <strong>table_args</strong>를 활용해서 unique constraint를 만들긴 했지만 따로 활용하지는 않았다.</p>
<hr>
<h3 id="2-특성-테이블">2. 특성 테이블</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># models.py 일부</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Feature</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    feature_code <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">255</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    description <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Text, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Association table for many-to-many relationship between Product and Feature</span>
</span></span><span style="display:flex;"><span>product_features <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Table(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;product_features&#34;</span>,
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#34;product_id&#34;</span>, db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#34;product.id&#34;</span>), primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#34;feature_id&#34;</span>, db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#34;feature.id&#34;</span>), primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><div style="text-align: center">
  <img src="feature_table.png" alt="특성 테이블 구상표" style="max-width: 100%;
  height: auto;">
  <div style="font-size: 0.9em; color: gray">특성 테이블 구상표</div>
  <br />
</div>

위의 표와 같은 형식으로 정리하기 위해 feature 테이블을 구성했다.</p>
<h4 id="21-특성-데이터베이스-저장-방법">2.1 특성 데이터베이스 저장 방법</h4>
<p>기본적으로 특성을 먼저 저장한 뒤에 저장한 특성을 제품과 연결한다. 특성을 저장할 때 이미 있는 특성인지 파악한 뒤에 이미 있는 특성인 경우 곧바로 제품과 해당 특성을 연결한다. 해당 과정을 수행하는 함수는 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># utils.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_and_add_feature_name</span>(name, feature_code, value, prod):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Check if the feature already exists</span>
</span></span><span style="display:flex;"><span>    existing_feature <span style="color:#f92672">=</span> Feature<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter_by(name<span style="color:#f92672">=</span>name, value<span style="color:#f92672">=</span>value)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> existing_feature:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Feature name: &#39;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, value: &#39;</span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; already exists.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if the product already has this feature</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> existing_feature <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> prod<span style="color:#f92672">.</span>features:
</span></span><span style="display:flex;"><span>            prod<span style="color:#f92672">.</span>features<span style="color:#f92672">.</span>append(existing_feature)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create a new feature if it doesn&#39;t exist</span>
</span></span><span style="display:flex;"><span>        new_feature <span style="color:#f92672">=</span> Feature(name<span style="color:#f92672">=</span>name, value<span style="color:#f92672">=</span>value, feature_code<span style="color:#f92672">=</span>feature_code)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(new_feature)
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Feature &#39;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, value: &#39;</span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; added to the database.&#34;</span>)
</span></span><span style="display:flex;"><span>        prod<span style="color:#f92672">.</span>features<span style="color:#f92672">.</span>append(new_feature)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Commit the changes to the database</span>
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><hr>
<h3 id="3-제품-과거-가격-테이블">3. 제품 과거 가격 테이블</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># models.py 중 일부</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProductLowestPriceHistory</span>(db<span style="color:#f92672">.</span>Model):
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    product_id <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Integer, db<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#34;product.id&#34;</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    date <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Date, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    lowest_price <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>Float, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>해당 날짜의 가장 낮은 가격(판매가)를 기록한다. 제품 id를 외래키로 갖는다.</p>
<hr>
<h3 id="4-데이터-전처리-함수">4. 데이터 전처리 함수</h3>
<p>기타 데이터베이스 운영을 위한 함수를 소개한다.</p>
<h4 id="41-없는-제품-삭제-함수">4.1 없는 제품 삭제 함수</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># update_or_create_product.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_old_products</span>():
</span></span><span style="display:flex;"><span>    today <span style="color:#f92672">=</span> date<span style="color:#f92672">.</span>today()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Delete products that were not checked today</span>
</span></span><span style="display:flex;"><span>    Product<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter(Product<span style="color:#f92672">.</span>last_checked <span style="color:#f92672">!=</span> today)<span style="color:#f92672">.</span>delete()
</span></span><span style="display:flex;"><span>    Product<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter(Product<span style="color:#f92672">.</span>features_scraped <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>delete()
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><p>매일 업데이트 하는 과정에서 당일 획득되지 않은 제품을 삭제한다. 이는 과거에는 쿠팡 제품 리스트에 있었지만 품절, 삭제 등의 이유로 수집되지 않은 제품을 포함한다.
하루만이라도 없으면 제품 자체를 삭제하는 것은 좀 과하다고 판단이 되서 추후 수정 예정이다.</p>
<h4 id="42-최고-조건-유지-함수">4.2 최고 조건 유지 함수</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># utils.py 중 일부</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">isit_best_offer</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Query to find all unique (model_name, tv_type) combinations</span>
</span></span><span style="display:flex;"><span>    product_groups <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>query(Product<span style="color:#f92672">.</span>model_name, Product<span style="color:#f92672">.</span>tv_type)<span style="color:#f92672">.</span>distinct()<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> group <span style="color:#f92672">in</span> product_groups:
</span></span><span style="display:flex;"><span>        model_name, tv_type <span style="color:#f92672">=</span> group
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 3: Find the product with the lowest price in each group</span>
</span></span><span style="display:flex;"><span>        lowest_priced_product <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>query(Product)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>filter_by(model_name<span style="color:#f92672">=</span>model_name, tv_type<span style="color:#f92672">=</span>tv_type)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>order_by(Product<span style="color:#f92672">.</span>lowest_price)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Step 4: Set best_offer to True for the lowest priced product</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> lowest_priced_product:
</span></span><span style="display:flex;"><span>            lowest_priced_product<span style="color:#f92672">.</span>best_offer <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Set best_offer to False for other products in the group</span>
</span></span><span style="display:flex;"><span>            other_products <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>                db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>query(Product)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>                    Product<span style="color:#f92672">.</span>id <span style="color:#f92672">!=</span> lowest_priced_product<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                    Product<span style="color:#f92672">.</span>model_name <span style="color:#f92672">==</span> model_name,
</span></span><span style="display:flex;"><span>                    Product<span style="color:#f92672">.</span>tv_type <span style="color:#f92672">==</span> tv_type,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> product <span style="color:#f92672">in</span> other_products:
</span></span><span style="display:flex;"><span>                product<span style="color:#f92672">.</span>best_offer <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Commit the changes to the database</span>
</span></span><span style="display:flex;"><span>    db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><p>같은 제품인데 다른 판매자가 판매하는 경우, 최저가 제품만 리스팅하기 위해 제품에 best_offer 필드를 만들었다. 서비스에서 제공할 때 best_offer가 true 값을 갖는 제품만 리스팅한다.</p>
<h2 id="수정-필요-사항">수정 필요 사항</h2>
<p>&hellip;</p>
<h2 id="같은-주제-게시글-모음">같은 주제 게시글 모음</h2>
 
<ul>
  
  <li><a href="/posts/posts/coupang-tv2-%EB%B0%B1%EC%97%94%EB%93%9C/">coupang TV[2] - 백엔드</a></li>
  
  <li><a href="/posts/posts/coupang-tv1-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84/">coupang TV[1] - 프로젝트 구조 설계</a></li>
  
</ul>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 0 0 0-6 3 3 0 0 0 0 6"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/indie-hacker/" rel="tag">indie hacker</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/flask/" rel="tag">flask</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/coupang-tv/" rel="tag">coupang tv</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/backend/" rel="tag">backend</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="이투식 avatar" src="/img/leetusik_black.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About 이투식</span>
	</div>
	<div class="authorbox__description">
		이런 투자 방식, 이투식입니다.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/posts/coupang-tv1-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">coupang TV[1] - 프로젝트 구조 설계</p>
		</a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/posts/coupang-tv2-%EB%B0%B1%EC%97%94%EB%93%9C/">coupang TV[2] - 백엔드</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/posts/coupang-tv1-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84/">coupang TV[1] - 프로젝트 구조 설계</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/services/">Services</a>&nbsp;
				<span class="widget__counter widget__counter--bubble">2</span>
				</li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/backend/" title="Backend">Backend</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/coupang-tv/" title="Coupang Tv">Coupang Tv</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/flask/" title="Flask">Flask</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/indie-hacker/" title="Indie Hacker">Indie Hacker</a>
	</div>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Instagram" rel="noopener noreferrer" href="https://www.instagram.com/leetusik" target="_blank">
				<svg class="widget-social__link-icon icon icon-instagram" width="24" height="24" viewBox="0 0 256 256"><circle cx="193" cy="59" r="15"/><path fill-rule="evenodd" d="M101 0h54c41 0 58.4 3.9 74.5 17C256.2 37.5 256 74.8 256 97.7v60c0 26.7 0 60.4-26.5 81.4-16 13.4-33.5 16.9-74.5 16.9h-54c-41 0-57.5-3.5-74.5-16.9C1 218.9.5 186.3.1 160.5L0 155V97.7c0-23-.2-60.2 26.5-80.7C45 2 60 0 101 0zm4.9 23h44.3c45.8 0 58.3 3.5 70.3 17.5 11.8 13.2 12 30.1 12.5 62.9V156c.2 20.8.3 45.8-12.5 59.5-12 14-24.5 17.5-70.3 17.5h-44.3c-45.9 0-57.3-3.5-70.4-17.5-12.2-13-12.3-36.5-12.4-56.7v-55.6c.4-32.6.7-49.6 12.4-62.7C48 26.5 60 23 105.9 23zm19.6 144.5a42 42 0 1 0 0-84 42 42 0 0 0 0 84zm0 22.5a64.5 64.5 0 1 0 0-129 64.5 64.5 0 0 0 0 129z"/></svg>
				<span>Instagram</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/leetusik" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:leetusik@gmail.com">
				<svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 24 24"><path d="M0 3h24v18H0zm2 16h20V7l-10 6L2 7zM22 5H2l10 6z"/></svg>
				<span>leetusik@gmail.com</span>
			</a>
		</div>

		
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 이투식.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>